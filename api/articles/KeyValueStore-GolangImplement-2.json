{"title":"(第二弹)使用Golang实现一个并发安全的Map","uid":"47859f6ed3b9b77bc9f9046f0cd4ce8c","slug":"KeyValueStore-GolangImplement-2","date":"2022-07-21T07:39:53.000Z","updated":"2022-07-21T07:51:35.585Z","comments":true,"path":"api/articles/KeyValueStore-GolangImplement-2.json","keywords":null,"cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.opss.cn%2Fwp-content%2Fuploads%2F2020%2F03%2F202003130037042.jpg&refer=http%3A%2F%2Fwww.opss.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1660637907&t=d526a07a4c3db6183eb24202caa43381","content":"<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>上回说到，用Golang实现了一个高性能的kv，但是由于锁的关系，即使有多个go程并发对kv进行操作，但还是会因为全局的锁导致一go干活，多go看戏的场面，今天就来优化一下这个kv，让它实现真正的并发干活</p></blockquote>\n<h1 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h1><p>总体设计思路还是没有变滴，我们还是要用上次那个模型进行总体设计，但是我们引入了一个新的机制：将dirty数据分散存储到若干个map里，这样锁就只会锁住单个map，其余的map还是可以进行读写操作的，通过这样来让多go程真正地并发工作</p>\n<p>总体结构图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/07/21/jqERrd.png\" alt=\"structure overview\"></p>\n<p>读写流程图：</p>\n<p><img src=\"https://s1.ax1x.com/2022/07/21/jqElEq.png\" alt=\"operation overview\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>先拿上次的图顶个数，下次更新再把图放上来，总体也差不多</p></blockquote>\n<h1 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h1><p>相对于上次的实现，我们引入了更多的文件：</p>\n<pre class=\"line-numbers language-txt\" data-language=\"txt\"><code class=\"language-txt\">.\n|-- buff.go         // 缓冲channel相关实现\n|-- db.go           // kv主体实现\n|-- db_test.go      // 测试文件\n|-- dirty.go        // dirtyMap与实际存储的entity的实现\n|-- error.go        // 自定义错误\n`-- operator.go     // 具体操作kv的实现<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"buff-go\"><a href=\"#buff-go\" class=\"headerlink\" title=\"buff.go\"></a>buff.go</h2><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> kv\n\n<span class=\"token keyword\">type</span> typeRequest <span class=\"token builtin\">int</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span>\n\tgetValue typeRequest <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span>\n\tsetValue\n\tdeleteKey\n\trangeDB\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> typeResponse <span class=\"token builtin\">int</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span>\n\twithError typeResponse <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span>\n\twithValue\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> requestFields <span class=\"token builtin\">int</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span>\n\trequestKey requestFields <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span>\n\trequestValue\n\trequestTimeout\n\trequestFunc\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> responseFields <span class=\"token builtin\">int</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">(</span>\n\tresponseKey responseFields <span class=\"token operator\">=</span> <span class=\"token boolean\">iota</span>\n\tresponseValue\n\tresponseTimeout\n\tresponseError\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> dbRequest <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\trequestType typeRequest\n\targs        <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>requestFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\tcallback    <span class=\"token keyword\">chan</span> dbResponse\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">type</span> dbResponse <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tresponseType typeResponse\n\treturns      <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>responseFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">newDbRequest</span><span class=\"token punctuation\">(</span>rType typeRequest<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span>dbRequest <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>dbRequest<span class=\"token punctuation\">&#123;</span>\n\t\trequestType<span class=\"token punctuation\">:</span> rType<span class=\"token punctuation\">,</span>\n\t\targs<span class=\"token punctuation\">:</span>        <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>requestFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tcallback<span class=\"token punctuation\">:</span>    <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> dbResponse<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"db-go\"><a href=\"#db-go\" class=\"headerlink\" title=\"db.go\"></a>db.go</h2><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> kv\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"sync\"</span>\n\t<span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> IDatabase <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">Set</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>v <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> t time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">,</span> e <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">Delete</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ok <span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>f <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">NewDatabase</span><span class=\"token punctuation\">(</span>workers<span class=\"token punctuation\">,</span> buffSize<span class=\"token punctuation\">,</span> dirtyCount <span class=\"token builtin\">uint</span><span class=\"token punctuation\">,</span> hash <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> IDatabase <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">// init kv-database</span>\n\tdb <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>database<span class=\"token punctuation\">&#123;</span>\n\t\tbuff<span class=\"token punctuation\">:</span>    <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token operator\">*</span>dbRequest<span class=\"token punctuation\">,</span> buffSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\texit<span class=\"token punctuation\">:</span>    <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tdata<span class=\"token punctuation\">:</span>    <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>dirtyMap<span class=\"token punctuation\">,</span> dirtyCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tsize<span class=\"token punctuation\">:</span>    dirtyCount<span class=\"token punctuation\">,</span>\n\t\tworkers<span class=\"token punctuation\">:</span> workers<span class=\"token punctuation\">,</span>\n\t\thash<span class=\"token punctuation\">:</span>    hash<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token comment\">// init dirty-map</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token function\">uint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> dirtyCount<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span>\n\t\tdb<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>dirtyMap<span class=\"token punctuation\">&#123;</span>\n\t\t\tlock<span class=\"token punctuation\">:</span>  sync<span class=\"token punctuation\">.</span>RWMutex<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t\t\tdirty<span class=\"token punctuation\">:</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>entity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token comment\">// start up operators</span>\n\tdb<span class=\"token punctuation\">.</span><span class=\"token function\">operator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> db\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">type</span> database <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tsize    <span class=\"token builtin\">uint</span>\n\tworkers <span class=\"token builtin\">uint</span>\n\tbuff    <span class=\"token keyword\">chan</span> <span class=\"token operator\">*</span>dbRequest\n\texit    <span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\tdata    <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">uint</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>dirtyMap\n\thash    <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">uint</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">)</span> <span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\treq <span class=\"token operator\">:=</span> <span class=\"token function\">newDbRequest</span><span class=\"token punctuation\">(</span>getValue<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">)</span>\n\treq<span class=\"token punctuation\">.</span>args <span class=\"token operator\">=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>requestFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\trequestKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\td<span class=\"token punctuation\">.</span>buff <span class=\"token operator\">&lt;-</span> req\n\n\tresp <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>req<span class=\"token punctuation\">.</span>callback\n\t<span class=\"token keyword\">switch</span> resp<span class=\"token punctuation\">.</span>responseType <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">case</span> withError<span class=\"token punctuation\">:</span>\n\t\terr <span class=\"token operator\">:=</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseError<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Duration</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n\t\t<span class=\"token keyword\">return</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseTimeout<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">)</span> <span class=\"token function\">Set</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>v <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> t time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">,</span> e <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\treq <span class=\"token operator\">:=</span> <span class=\"token function\">newDbRequest</span><span class=\"token punctuation\">(</span>setValue<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">)</span>\n\treq<span class=\"token punctuation\">.</span>args <span class=\"token operator\">=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>requestFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\trequestKey<span class=\"token punctuation\">:</span>     key<span class=\"token punctuation\">,</span>\n\t\trequestValue<span class=\"token punctuation\">:</span>   value<span class=\"token punctuation\">,</span>\n\t\trequestTimeout<span class=\"token punctuation\">:</span> timeout<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\td<span class=\"token punctuation\">.</span>buff <span class=\"token operator\">&lt;-</span> req\n\n\tresp <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>req<span class=\"token punctuation\">.</span>callback\n\t<span class=\"token keyword\">switch</span> resp<span class=\"token punctuation\">.</span>responseType <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">case</span> withError<span class=\"token punctuation\">:</span>\n\t\terr <span class=\"token operator\">:=</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseError<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Duration</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n\t\t<span class=\"token keyword\">return</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseTimeout<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">)</span> <span class=\"token function\">Delete</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ok <span class=\"token builtin\">bool</span><span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\treq <span class=\"token operator\">:=</span> <span class=\"token function\">newDbRequest</span><span class=\"token punctuation\">(</span>deleteKey<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">)</span>\n\treq<span class=\"token punctuation\">.</span>args <span class=\"token operator\">=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>requestFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\trequestKey<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\td<span class=\"token punctuation\">.</span>buff <span class=\"token operator\">&lt;-</span> req\n\n\tresp <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>req<span class=\"token punctuation\">.</span>callback\n\t<span class=\"token keyword\">switch</span> resp<span class=\"token punctuation\">.</span>responseType <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">case</span> withError<span class=\"token punctuation\">:</span>\n\t\terr <span class=\"token operator\">:=</span> resp<span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">[</span>responseError<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> err\n\t<span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">)</span> <span class=\"token function\">Range</span><span class=\"token punctuation\">(</span>f <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\treq <span class=\"token operator\">:=</span> <span class=\"token function\">newDbRequest</span><span class=\"token punctuation\">(</span>rangeDB<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">)</span>\n\treq<span class=\"token punctuation\">.</span>args <span class=\"token operator\">=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>requestFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\trequestFunc<span class=\"token punctuation\">:</span> f<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\td<span class=\"token punctuation\">.</span>buff <span class=\"token operator\">&lt;-</span> req\n\n\t<span class=\"token operator\">&lt;-</span>req<span class=\"token punctuation\">.</span>callback\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">)</span> <span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\td<span class=\"token punctuation\">.</span>exit <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"dirty-go\"><a href=\"#dirty-go\" class=\"headerlink\" title=\"dirty.go\"></a>dirty.go</h2><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> kv\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"sync\"</span>\n\t<span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">type</span> entity <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\ttimeout time<span class=\"token punctuation\">.</span>Time\n\tdata    <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">type</span> dirtyMap <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tlock  sync<span class=\"token punctuation\">.</span>RWMutex\n\tdirty <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>entity\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"error-go\"><a href=\"#error-go\" class=\"headerlink\" title=\"error.go\"></a>error.go</h2><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> kv\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"fmt\"</span>\n\n<span class=\"token keyword\">type</span> outOfRangeError <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tupperIndex <span class=\"token builtin\">int</span>\n\tlowerIndex <span class=\"token builtin\">int</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>o outOfRangeError<span class=\"token punctuation\">)</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"kv-db out of range with [%v:%v]\"</span><span class=\"token punctuation\">,</span> o<span class=\"token punctuation\">.</span>lowerIndex<span class=\"token punctuation\">,</span> o<span class=\"token punctuation\">.</span>upperIndex<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">type</span> notFoundError <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tkey <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>n notFoundError<span class=\"token punctuation\">)</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"kv-db cannot find key: %#v\"</span><span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"operator-go\"><a href=\"#operator-go\" class=\"headerlink\" title=\"operator.go\"></a>operator.go</h2><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token keyword\">package</span> kv\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n\t<span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">)</span> <span class=\"token function\">operator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">// start up exit listener</span>\n\texitChan <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">.</span>workers<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">listenExitChan</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>exit<span class=\"token punctuation\">,</span> exitChan<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">.</span>workers<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// start up operators</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token function\">uint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> d<span class=\"token punctuation\">.</span>workers<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">go</span> <span class=\"token function\">startupOperator</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> exitChan<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">listenExitChan</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">,</span> to <span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> workers <span class=\"token builtin\">uint</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">select</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>from<span class=\"token punctuation\">:</span>\n\t\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token function\">uint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> workers<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\tto <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">startupOperator</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">,</span> e <span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">select</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">case</span> request <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>d<span class=\"token punctuation\">.</span>buff<span class=\"token punctuation\">:</span>\n\t\t\t<span class=\"token keyword\">switch</span> request<span class=\"token punctuation\">.</span>requestType <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">case</span> getValue<span class=\"token punctuation\">:</span>\n\t\t\t\trequest<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">&lt;-</span> <span class=\"token function\">getValueOperate</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span>requestKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">case</span> setValue<span class=\"token punctuation\">:</span>\n\t\t\t\trequest<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">&lt;-</span> <span class=\"token function\">setValueOperate</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span>requestKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span>requestValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span>requestTimeout<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">case</span> deleteKey<span class=\"token punctuation\">:</span>\n\t\t\t\trequest<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">&lt;-</span> <span class=\"token function\">deleteKeyOperate</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span>requestKey<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">case</span> rangeDB<span class=\"token punctuation\">:</span>\n\t\t\t\trequest<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">&lt;-</span> <span class=\"token function\">rangeDbOperate</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span>requestFunc<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>e<span class=\"token punctuation\">:</span>\n\t\t\t<span class=\"token keyword\">return</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">getValueOperate</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">,</span> key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>resp dbResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">// get dirty-map index and set read-lock</span>\n\tindex <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> d<span class=\"token punctuation\">.</span>size\n\t_map <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n\t_map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">RLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> _map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">RUnlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> v<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> _map<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">!</span>ok <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token comment\">// condition: cannot find key in dirty-map</span>\n\t\t<span class=\"token comment\">// return error</span>\n\t\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\t\tresponseType<span class=\"token punctuation\">:</span> withError<span class=\"token punctuation\">,</span>\n\t\t\treturns<span class=\"token punctuation\">:</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>responseFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\t\t\tresponseError<span class=\"token punctuation\">:</span> notFoundError<span class=\"token punctuation\">&#123;</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token comment\">// condition: get entity succeed in dirty-map</span>\n\t\t<span class=\"token keyword\">if</span> v<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">.</span><span class=\"token function\">Before</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token comment\">// condition: key-value pair timeout</span>\n\t\t\t<span class=\"token comment\">// delete key-value pair</span>\n\t\t\t_map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">defer</span> _map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>_map<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n\n\t\t\t<span class=\"token comment\">// return error</span>\n\t\t\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\t\t\tresponseType<span class=\"token punctuation\">:</span> withError<span class=\"token punctuation\">,</span>\n\t\t\t\treturns<span class=\"token punctuation\">:</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>responseFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\t\t\t\tresponseError<span class=\"token punctuation\">:</span> notFoundError<span class=\"token punctuation\">&#123;</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token comment\">// condition: key-value pair not timeout</span>\n\t\t\t<span class=\"token comment\">// return value</span>\n\t\t\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\t\t\tresponseType<span class=\"token punctuation\">:</span> withValue<span class=\"token punctuation\">,</span>\n\t\t\t\treturns<span class=\"token punctuation\">:</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>responseFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\t\t\t\tresponseValue<span class=\"token punctuation\">:</span>   v<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n\t\t\t\t\tresponseTimeout<span class=\"token punctuation\">:</span> v<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token keyword\">return</span> resp\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">setValueOperate</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> timeout time<span class=\"token punctuation\">.</span>Duration<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>resp dbResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">// get dirty-map index and set write-lock</span>\n\tindex <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> d<span class=\"token punctuation\">.</span>size\n\t_map <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n\t_map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> _map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// update dirty-map</span>\n\tv <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>entity<span class=\"token punctuation\">&#123;</span>\n\t\ttimeout<span class=\"token punctuation\">:</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tdata<span class=\"token punctuation\">:</span>    value<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t_map<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v\n\n\t<span class=\"token comment\">// return value</span>\n\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\tresponseType<span class=\"token punctuation\">:</span> withValue<span class=\"token punctuation\">,</span>\n\t\treturns<span class=\"token punctuation\">:</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span>responseFields<span class=\"token punctuation\">]</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>\n\t\t\tresponseValue<span class=\"token punctuation\">:</span>   v<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n\t\t\tresponseTimeout<span class=\"token punctuation\">:</span> v<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token keyword\">return</span> resp\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">deleteKeyOperate</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">,</span> key <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>resp dbResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">// get dirty-map index and set read-lock</span>\n\tindex <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> d<span class=\"token punctuation\">.</span>size\n\t_map <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n\t_map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">RLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">defer</span> _map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">RUnlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> _map<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">!</span>ok <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token comment\">// condition: cannot find key in dirty-map</span>\n\t\t<span class=\"token comment\">// return value</span>\n\t\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\t\tresponseType<span class=\"token punctuation\">:</span> withValue<span class=\"token punctuation\">,</span>\n\t\t\treturns<span class=\"token punctuation\">:</span>      <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token comment\">// delete key-value pair</span>\n\t\t_map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">defer</span> _map<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>_map<span class=\"token punctuation\">.</span>dirty<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token comment\">// return value</span>\n\t\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\t\tresponseType<span class=\"token punctuation\">:</span> withValue<span class=\"token punctuation\">,</span>\n\t\t\treturns<span class=\"token punctuation\">:</span>      <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token keyword\">return</span> resp\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">rangeDbOperate</span><span class=\"token punctuation\">(</span>d <span class=\"token operator\">*</span>database<span class=\"token punctuation\">,</span> f <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">interface</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>resp dbResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token function\">uint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> d<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token comment\">// set write-lock</span>\n\t\tcurrent <span class=\"token operator\">:=</span> d<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n\t\tcurrent<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token comment\">// execute function</span>\n\t\t<span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> current<span class=\"token punctuation\">.</span>dirty <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token function\">f</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t\tcurrent<span class=\"token punctuation\">.</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token comment\">// return value</span>\n\tresp <span class=\"token operator\">=</span> dbResponse<span class=\"token punctuation\">&#123;</span>\n\t\tresponseType<span class=\"token punctuation\">:</span> withValue<span class=\"token punctuation\">,</span>\n\t\treturns<span class=\"token punctuation\">:</span>      <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token keyword\">return</span> resp\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><p>经测试，多go程的情况下，进行一千万次读写所用的总时间为8.6s，比上次进行的单go程性能更优</p>\n","text":" 上回说到，用Golang实现了一个高性能的kv，但是由于锁的关系，即使有多个go程并发对kv进行操作，但还是会因为全局的锁导致一go干活，多go看戏的场面，今天就来优化一下这个kv，让它实现真正的并发干活 思路总体设计思路还是没有变滴，我们还是要用上次那个模型进行总体设计，但是...","link":"","photos":[],"count_time":{"symbolsCount":"9.7k","symbolsTime":"9 mins."},"categories":[{"name":"blog","slug":"blog","count":11,"path":"api/categories/blog.json"}],"tags":[{"name":"Golang","slug":"Golang","count":9,"path":"api/tags/Golang.json"},{"name":"Redis","slug":"Redis","count":2,"path":"api/tags/Redis.json"},{"name":"KeyValue","slug":"KeyValue","count":2,"path":"api/tags/KeyValue.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%80%9D%E8%B7%AF\"><span class=\"toc-text\">思路</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">实现</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#buff-go\"><span class=\"toc-text\">buff.go</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#db-go\"><span class=\"toc-text\">db.go</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#dirty-go\"><span class=\"toc-text\">dirty.go</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#error-go\"><span class=\"toc-text\">error.go</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#operator-go\"><span class=\"toc-text\">operator.go</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">测试</span></a></li></ol>","author":{"name":"𝚂𝚞𝚗𝚒𝚜𝚝𝙲","slug":"blog-author","avatar":"/assets/img/favicon.png","link":"/","description":"𝚂𝚞𝚗𝚒𝚜𝚝𝙲 is a pigeon from SouthWest University","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/assets/svg/bilibili.svg","link":"https://space.bilibili.com/25394898"},"live":{"icon":"/assets/svg/live.svg","link":"https://live.bilibili.com/5184681"},"github":{"icon":"/assets/svg/github.svg","link":"https://github.com/sunist-c"},"institution":{"icon":"/assets/svg/institution.svg","link":"https://github.com/swu-acm-lab"},"outlook":{"icon":"/assets/svg/outlook.svg","link":"mailto:sunist@mail.swu-acm.cn"}}}},"mapped":true,"prev_post":{},"next_post":{"title":"使用Golang实现一个并发安全的Map","uid":"9d5491a5ddb5a138c7973036a7b8ad61","slug":"KeyValueStore-GolangImplement","date":"2022-07-20T09:16:54.000Z","updated":"2022-07-21T01:28:35.552Z","comments":true,"path":"api/articles/KeyValueStore-GolangImplement.json","keywords":null,"cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.opss.cn%2Fwp-content%2Fuploads%2F2020%2F03%2F202003130037042.jpg&refer=http%3A%2F%2Fwww.opss.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1660637907&t=d526a07a4c3db6183eb24202caa43381","text":" 这篇博文是CeobeBot的框架CeobeBotFramework的kv部分的总结 总说redis单线程性能高，最近正好在实现自拟的框架，于是产生了一个用golang实现一个高性能kv的想法，进行了一天的coding、单元测试和基准测试以后，得出的结论是： 有锁的并发kv性能低...","link":"","photos":[],"count_time":{"symbolsCount":"14k","symbolsTime":"13 mins."},"categories":[{"name":"blog","slug":"blog","count":11,"path":"api/categories/blog.json"}],"tags":[{"name":"Golang","slug":"Golang","count":9,"path":"api/tags/Golang.json"},{"name":"Redis","slug":"Redis","count":2,"path":"api/tags/Redis.json"},{"name":"KeyValue","slug":"KeyValue","count":2,"path":"api/tags/KeyValue.json"}],"author":{"name":"𝚂𝚞𝚗𝚒𝚜𝚝𝙲","slug":"blog-author","avatar":"/assets/img/favicon.png","link":"/","description":"𝚂𝚞𝚗𝚒𝚜𝚝𝙲 is a pigeon from SouthWest University","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/assets/svg/bilibili.svg","link":"https://space.bilibili.com/25394898"},"live":{"icon":"/assets/svg/live.svg","link":"https://live.bilibili.com/5184681"},"github":{"icon":"/assets/svg/github.svg","link":"https://github.com/sunist-c"},"institution":{"icon":"/assets/svg/institution.svg","link":"https://github.com/swu-acm-lab"},"outlook":{"icon":"/assets/svg/outlook.svg","link":"mailto:sunist@mail.swu-acm.cn"}}}}}}